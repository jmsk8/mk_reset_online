<style>
    @media screen and (max-width: 1023px) {
        .navbar-menu {
            background-color: #1e293b !important;
            box-shadow: 0 8px 16px rgba(0,0,0,0.5);
            padding: 0.75rem;
        }

        .navbar-item, .navbar-link {
            color: #e2e8f0 !important;
        }

        a.navbar-item:hover, a.navbar-item:focus, a.navbar-item:active,
        .navbar-link:hover, .navbar-link:focus, .navbar-link:active {
            background-color: rgba(59, 130, 246, 0.2) !important; 
            color: #ffffff !important;
        }

        .navbar-item.has-dropdown .navbar-dropdown {
            background-color: rgba(0, 0, 0, 0.2) !important;
            border: none !important;
        }
        
        .navbar-link:not(.is-arrowless)::after {
            border-color: #e2e8f0 !important;
        }
    }

    @media screen and (max-width: 768px) {
        .navbar-brand {
            min-height: 4rem;
        }
        
        .navbar-burger {
            height: 4rem;
            width: 4rem;
            font-size: 1.2rem;
            color: #e2e8f0;
        }
        
        .navbar-burger:hover, .navbar-burger:focus, .navbar-burger:active {
            background-color: rgba(59, 130, 246, 0.2) !important;
            color: white;
        }

        .navbar-item.brand-item {
            font-size: 1.4rem;
            padding-left: 1rem;
        }
        
        .navbar-item, .navbar-link {
            padding-top: 1rem !important;
            padding-bottom: 1rem !important;
            font-size: 1.1rem;
        }
    }
</style>

<nav class="navbar is-dark" role="navigation" aria-label="main navigation">
  <div class="container">
    <div class="navbar-brand">
      <a class="navbar-item brand-item" href="/">
        <i class="fas fa-gamepad"></i>
        <strong class="ml-2">MK Reset</strong>
      </a>
      <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbarMenu">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </a>
    </div>

    <div id="navbarMenu" class="navbar-menu">
      <div class="navbar-start">
        <a class="navbar-item" href="/classement">
          <span class="icon"><i class="fas fa-trophy"></i></span>
          <span>Classement</span>
        </a>
        
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link">
            <span class="icon"><i class="fas fa-chart-bar"></i></span>
            <span>Statistiques</span>
          </a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="/stats/joueurs">
              <span class="icon"><i class="fas fa-users"></i></span>
              <span>Par Joueur</span>
            </a>
            <a class="navbar-item" href="/stats/tournois">
              <span class="icon"><i class="fas fa-calendar-alt"></i></span>
              <span>Par Tournoi</span>
            </a>
          </div>
        </div>

        <a class="navbar-item" href="/recap">
          <span class="icon"><i class="fas fa-history"></i></span>
          <span>Récapitulatifs</span>
        </a>
      </div>

      <div class="navbar-end">
        {% if session.get('admin_token') %}
          <div class="navbar-item has-dropdown is-hoverable">
            <a class="navbar-link has-text-warning">
              <span class="icon"><i class="fas fa-user-shield"></i></span>
              <span>Admin</span>
            </a>
            
            <div class="navbar-dropdown is-right">
              <a class="navbar-item" href="/add_tournament">
                <i class="fas fa-plus-circle mr-2"></i> Ajouter Tournoi
              </a>
              <a class="navbar-item" href="/admin/gestion">
                <i class="fas fa-users-cog mr-2"></i> Gérer Joueurs
              </a>
              
              <a class="navbar-item" href="/admin/ligues">
                <i class="fas fa-shield-alt mr-2"></i> Gérer Ligues
              </a>

              <a class="navbar-item" href="/admin/saisons-gestion">
                <i class="fas fa-calendar-alt mr-2"></i> Gérer Saisons
              </a>
              
              <hr class="navbar-divider">
              
              <a class="navbar-item has-text-danger" onclick="revertLastTournament()">
                <i class="fas fa-undo mr-2"></i> Annuler dernier tournoi
              </a>
              
              <hr class="navbar-divider">
              
              <a class="navbar-item" href="/admin/logout">
                <i class="fas fa-sign-out-alt mr-2"></i> Déconnexion
              </a>
            </div>
          </div>
        {% else %}
          <div class="navbar-item">
            <a class="button is-primary" href="/admin">
              <span class="icon"><i class="fas fa-lock"></i></span>
              <span>Admin</span>
            </a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</nav>

{% if session.get('admin_token') %}
<div id="session-warning-modal" class="modal">
  <div class="modal-background"></div>
  <div class="modal-card">
    <header class="modal-card-head has-background-warning">
      <p class="modal-card-title has-text-dark">⚠️ Session expirée bientôt</p>
    </header>
    <section class="modal-card-body has-text-dark">
      <p>Votre session administrateur va expirer dans moins d'une minute.</p>
      <p>Voulez-vous rester connecté ?</p>
    </section>
    <footer class="modal-card-foot">
      <button class="button is-success" id="btn-extend-session">Rester connecté</button>
      <a href="/admin/logout" class="button is-danger">Se déconnecter</a>
    </footer>
  </div>
</div>
{% endif %}

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Gestion du menu Burger mobile
    const $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);
    if ($navbarBurgers.length > 0) {
      $navbarBurgers.forEach( el => {
        el.addEventListener('click', () => {
          const target = el.dataset.target;
          const $target = document.getElementById(target);
          el.classList.toggle('is-active');
          $target.classList.toggle('is-active');
        });
      });
    }

    // Gestion de l'expiration de session
    const remainingSeconds = {{ session_lifetime|default(1800)|round|int }};
    const warningBuffer = 60;
    
    if (document.getElementById('session-warning-modal')) {
      const modal = document.getElementById('session-warning-modal');
      const btnExtend = document.getElementById('btn-extend-session');
      let logoutTimer;
      let warningTimer;

      console.log("Temps de session restant : " + remainingSeconds + " secondes");

      function startTimers(secondsLeft) {
        if (logoutTimer) clearTimeout(logoutTimer);
        if (warningTimer) clearTimeout(warningTimer);

        if (secondsLeft > 0) {
            logoutTimer = setTimeout(() => {
            window.location.href = '/admin/logout';
            }, secondsLeft * 1000);
        } else {
            window.location.href = '/admin/logout';
            return;
        }

        const timeBeforeWarning = (secondsLeft - warningBuffer) * 1000;
        
        if (timeBeforeWarning > 0) {
          warningTimer = setTimeout(() => {
            modal.classList.add('is-active');
          }, timeBeforeWarning);
        } else {
          modal.classList.add('is-active');
        }
      }

      startTimers(remainingSeconds);

      btnExtend.addEventListener('click', () => {
        btnExtend.classList.add('is-loading');
        
        const csrfToken = "{{ csrf_token() }}";
        fetch('/admin/refresh', {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrfToken
          }
        })
        .then(res => res.json())
        .then(data => {
          btnExtend.classList.remove('is-loading');
          if (data.status === 'success') {
            modal.classList.remove('is-active');
            startTimers(1800); 
            console.log("Session rafraîchie pour 30 minutes");
          } else {
            alert("Erreur lors du rafraîchissement. Redirection...");
            window.location.href = '/admin/logout';
          }
        })
        .catch(() => {
          window.location.href = '/admin/logout';
        });
      });
    }
  });

  function revertLastTournament() {
    if (!confirm("⚠️ ATTENTION : Voulez-vous vraiment ANNULER le dernier tournoi enregistré ?\n\nLes scores des joueurs reviendront à leur état précédent.\nCette action est irréversible (mais un backup sera créé).")) {
        return;
    }

    document.body.style.cursor = 'wait';
    const csrfToken = "{{ csrf_token() }}";

    fetch('/admin/revert_last', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        document.body.style.cursor = 'default';
        if (data.status === 'success') {
            alert("✅ Succès : " + data.message);
            window.location.reload();
        } else {
            alert("❌ Erreur : " + (data.message || data.error));
        }
    })
    .catch(err => {
        document.body.style.cursor = 'default';
        alert("Erreur réseau");
    });
  }
</script>
