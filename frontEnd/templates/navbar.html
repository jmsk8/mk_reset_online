<nav class="navbar is-dark" role="navigation" aria-label="main navigation">
  <div class="container">
    <div class="navbar-brand">
      <a class="navbar-item brand-item" href="/">
        <i class="fas fa-gamepad"></i>
        <strong class="ml-2">MK Reset</strong>
      </a>
      <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbarMenu">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </a>
    </div>

    <div id="navbarMenu" class="navbar-menu">
      <div class="navbar-start">
        <a class="navbar-item" href="/classement">
          <span class="icon"><i class="fas fa-trophy"></i></span>
          <span>Classement</span>
        </a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link">
            <span class="icon"><i class="fas fa-chart-bar"></i></span>
            <span>Statistiques</span>
          </a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="/stats/joueurs">
              <span class="icon"><i class="fas fa-users"></i></span>
              <span>Par Joueur</span>
            </a>
            <a class="navbar-item" href="/stats/tournois">
              <span class="icon"><i class="fas fa-calendar-alt"></i></span>
              <span>Par Tournoi</span>
            </a>
          </div>
        </div>
      </div>

      <div class="navbar-end">
        {% if session.get('admin_token') %}
          <div class="navbar-item has-dropdown is-hoverable">
            <a class="navbar-link has-text-warning">
              <span class="icon"><i class="fas fa-user-shield"></i></span>
              <span>Admin</span>
            </a>
            <div class="navbar-dropdown is-right">
              <a class="navbar-item" href="/add_tournament">
                <i class="fas fa-plus-circle mr-2"></i> Ajouter Tournoi
              </a>
              <a class="navbar-item" href="/admin/gestion">
                <i class="fas fa-users-cog mr-2"></i> Gérer Joueurs
              </a>
              <hr class="navbar-divider">
              <a class="navbar-item has-text-danger" onclick="revertLastTournament()">
                <i class="fas fa-undo mr-2"></i> Annuler dernier tournoi
              </a>
              <hr class="navbar-divider">
              <a class="navbar-item" href="/admin/logout">
                <i class="fas fa-sign-out-alt mr-2"></i> Déconnexion
              </a>
            </div>
          </div>
        {% else %}
          <div class="navbar-item">
            <a class="button is-primary is-small" href="/admin">
              <span class="icon"><i class="fas fa-lock"></i></span>
              <span>Connexion</span>
            </a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</nav>

{% if session.get('admin_token') %}
<div id="session-warning-modal" class="modal">
  <div class="modal-background"></div>
  <div class="modal-card">
    <header class="modal-card-head has-background-warning">
      <p class="modal-card-title has-text-dark">⚠️ Session expirée bientôt</p>
    </header>
    <section class="modal-card-body has-text-dark">
      <p>Votre session administrateur va expirer dans moins d'une minute.</p>
      <p>Voulez-vous rester connecté ?</p>
    </section>
    <footer class="modal-card-foot">
      <button class="button is-success" id="btn-extend-session">Rester connecté</button>
      <a href="/admin/logout" class="button is-danger">Se déconnecter</a>
    </footer>
  </div>
</div>
{% endif %}

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Gestion du Menu Burger Mobile
    const $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);
    if ($navbarBurgers.length > 0) {
      $navbarBurgers.forEach( el => {
        el.addEventListener('click', () => {
          const target = el.dataset.target;
          const $target = document.getElementById(target);
          el.classList.toggle('is-active');
          $target.classList.toggle('is-active');
        });
      });
    }

    // --- LOGIQUE D'EXPIRATION DE SESSION ---
    // Récupère le temps restant injecté par Python. Si pas défini, défaut à 1800s (30min)
    const remainingSeconds = {{ session_lifetime|default(1800)|round|int }};
    const warningBuffer = 60; // Afficher l'alerte 60s avant la fin
    
    // On n'active le timer que si la modale existe (donc si on est admin)
    if (document.getElementById('session-warning-modal')) {
      const modal = document.getElementById('session-warning-modal');
      const btnExtend = document.getElementById('btn-extend-session');
      let logoutTimer;
      let warningTimer;

      console.log("Temps de session restant : " + remainingSeconds + " secondes");

      function startTimers(secondsLeft) {
        // Nettoyage des anciens timers pour éviter les doublons
        if (logoutTimer) clearTimeout(logoutTimer);
        if (warningTimer) clearTimeout(warningTimer);

        // 1. Timer de déconnexion forcée (quand le temps arrive à 0)
        if (secondsLeft > 0) {
            logoutTimer = setTimeout(() => {
            window.location.href = '/admin/logout';
            }, secondsLeft * 1000);
        } else {
            window.location.href = '/admin/logout';
            return;
        }

        // 2. Timer d'avertissement (60s avant la fin)
        const timeBeforeWarning = (secondsLeft - warningBuffer) * 1000;
        
        if (timeBeforeWarning > 0) {
          // S'il reste plus de 60s, on attend le bon moment
          warningTimer = setTimeout(() => {
            modal.classList.add('is-active');
          }, timeBeforeWarning);
        } else {
          // S'il reste moins de 60s au chargement de la page, on affiche l'alerte tout de suite
          modal.classList.add('is-active');
        }
      }

      // Lancement initial des timers
      startTimers(remainingSeconds);

      // Gestion du bouton "Rester connecté"
      btnExtend.addEventListener('click', () => {
        btnExtend.classList.add('is-loading');
        
        const csrfToken = "{{ csrf_token() }}";
        // Appel au backend pour renouveler le token
        fetch('/admin/refresh', {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrfToken
          }
        })
        .then(res => res.json())
        .then(data => {
          btnExtend.classList.remove('is-loading');
          if (data.status === 'success') {
            modal.classList.remove('is-active');
            // On relance les timers pour 30 minutes (1800 secondes) car le token est neuf
            startTimers(1800); 
            console.log("Session rafraîchie pour 30 minutes");
          } else {
            alert("Erreur lors du rafraîchissement. Redirection...");
            window.location.href = '/admin/logout';
          }
        })
        .catch(() => {
          window.location.href = '/admin/logout';
        });
      });
    }
  });

  // Fonction pour annuler le dernier tournoi
  function revertLastTournament() {
    if (!confirm("⚠️ ATTENTION : Voulez-vous vraiment ANNULER le dernier tournoi enregistré ?\n\nLes scores des joueurs reviendront à leur état précédent.\nCette action est irréversible (mais un backup sera créé).")) {
        return;
    }

    document.body.style.cursor = 'wait';
    const csrfToken = "{{ csrf_token() }}";

    fetch('/admin/revert_last', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        document.body.style.cursor = 'default';
        if (data.status === 'success') {
            alert("✅ Succès : " + data.message);
            window.location.reload();
        } else {
            alert("❌ Erreur : " + (data.message || data.error));
        }
    })
    .catch(err => {
        document.body.style.cursor = 'default';
        alert("Erreur réseau");
    });
  }
</script>
