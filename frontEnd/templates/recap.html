<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RÃ©capitulatif - {{ saison.nom_saison if saison else 'Erreur' }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/dark-mode.css">
    <link rel="stylesheet" href="/static/css/animations.css">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/mario-static.png') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='img/mario-static.png') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='img/mario-static.png') }}">
    <style>
        .recap-table th, 
        .recap-table td {
            padding: 0.35rem 0.5rem !important; 
            font-size: 0.9rem;
            vertical-align: middle !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
            height: 40px;
        }

        .recap-table {
            background-color: transparent !important;
            margin-bottom: 0 !important;
        }

        .recap-table tbody tr:nth-child(even) {
            background-color: rgba(255, 255, 255, 0.05) !important;
        }

        .award-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            transition: transform 0.3s ease;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .award-img {
            max-height: 60px;
            width: auto;
            filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.5));
        }

        .moai-container {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 20px;
            margin-bottom: 40px;
        }

        .moai-card {
            background: linear-gradient(180deg, rgba(30,41,59,0.9) 0%, rgba(15,23,42,0.95) 100%);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            width: 30%;
            position: relative;
        }
        
        .moai-img {
            max-height: 120px;
            width: auto;
            margin-bottom: 15px;
            transition: transform 0.3s;
        }
        
        .moai-gold {
            transform: scale(1.1);
            z-index: 2;
            border-color: rgba(255, 215, 0, 0.5);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.1);
        }
        
        .super-moai-gold {
            filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.8));
            animation: pulseGold 3s infinite;
        }
        .super-moai-silver {
            filter: drop-shadow(0 0 15px rgba(192, 192, 192, 0.8));
            animation: pulseSilver 3s infinite;
        }
        .super-moai-bronze {
            filter: drop-shadow(0 0 15px rgba(205, 127, 50, 0.8));
            animation: pulseBronze 3s infinite;
        }

        @keyframes pulseGold { 0% { filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.6)); } 50% { filter: drop-shadow(0 0 25px rgba(255, 215, 0, 1)); } 100% { filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.6)); } }
        @keyframes pulseSilver { 0% { filter: drop-shadow(0 0 10px rgba(192, 192, 192, 0.6)); } 50% { filter: drop-shadow(0 0 25px rgba(255, 255, 255, 0.9)); } 100% { filter: drop-shadow(0 0 10px rgba(192, 192, 192, 0.6)); } }
        @keyframes pulseBronze { 0% { filter: drop-shadow(0 0 10px rgba(205, 127, 50, 0.6)); } 50% { filter: drop-shadow(0 0 25px rgba(255, 160, 100, 0.9)); } 100% { filter: drop-shadow(0 0 10px rgba(205, 127, 50, 0.6)); } }

        .rank-badge {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background: #000;
            color: #fff;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            border: 2px solid #fff;
        }
        
        a.player-link {
            text-decoration: none;
            transition: color 0.2s;
        }
        a.player-link:hover {
            color: #3b82f6 !important; 
        }

        @media screen and (max-width: 1200px) {
            .moai-card .title {
                font-size: 1.1rem !important;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .moai-card .subtitle {
                font-size: 0.9rem !important;
            }
            .moai-img {
                max-height: 80px;
            }
            .moai-card {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    {% include 'navbar.html' %}

    <section class="hero is-small is-dark">
        <div class="hero-body">
            <div class="container has-text-centered">
                {% if saison %}
                    <h1 class="title is-1 glow-text">{{ saison.nom_saison }}</h1>
                    <p class="subtitle is-4 has-text-grey-light">
                        {% if saison.victory_condition == 'grand_master' %}
                            Course au Grand Master
                        {% else %}
                            CompÃ©tition {{ saison.victory_condition|capitalize }}
                        {% endif %}
                    </p>
                {% else %}
                    <h1 class="title is-1 has-text-danger">Saison introuvable</h1>
                    <a href="/" class="button is-primary mt-4">Retour Ã  l'accueil</a>
                {% endif %}
            </div>
        </div>
    </section>

    <section class="section">
        <div class="container">
            {% if saison %}
                
                <div class="columns is-variable is-6 mb-6">
                    <div class="column is-6">
                        <div class="card glass-card fade-in">
                            <header class="card-header">
                                <p class="card-header-title is-centered has-text-warning">
                                    <i class="fas fa-trophy mr-2"></i> Classement par Points
                                </p>
                            </header>
                            <div class="card-content p-0">
                                <table class="table is-fullwidth recap-table has-text-light">
                                    <thead>
                                        <tr>
                                            <th class="has-text-centered" style="width: 50px;">#</th>
                                            <th>Joueur</th>
                                            <th class="has-text-right">Pts</th>
                                            <th class="has-text-centered">Victoires</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for j in saison.classement_points %}
                                        <tr>
                                            <td class="has-text-centered font-weight-bold">
                                                {% if loop.index == 1 %}ðŸ¥‡{% elif loop.index == 2 %}ðŸ¥ˆ{% elif loop.index == 3 %}ðŸ¥‰{% else %}{{ loop.index }}{% endif %}
                                            </td>
                                            <td>
                                                <a href="/stats/joueur/{{ j.nom }}" class="has-text-light player-link"><strong>{{ j.nom }}</strong></a>
                                            </td>
                                            <td class="has-text-right has-text-weight-bold">{{ j.total_points }}</td>
                                            <td class="has-text-centered">{{ j.victoires }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="column is-6">
                        <div class="card glass-card fade-in" style="animation-delay: 0.2s">
                            <header class="card-header">
                                <p class="card-header-title is-centered has-text-info">
                                    <i class="fas fa-chart-bar mr-2"></i> Indice Performance (IP)
                                </p>
                            </header>
                            <div class="card-content p-0">
                                <table class="table is-fullwidth recap-table has-text-light">
                                    <thead>
                                        <tr>
                                            <th class="has-text-centered" style="width: 50px;">#</th>
                                            <th>Joueur</th>
                                            <th class="has-text-right">Moy. Pts</th>
                                            <th class="has-text-right" title="Moyenne pondÃ©rÃ©e (Base 100) + Bonus">IP Final</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for j in saison.classement_moyenne %}
                                        <tr>
                                            <td class="has-text-centered font-weight-bold">{{ loop.index }}</td>
                                            <td>
                                                <a href="/stats/joueur/{{ j.nom }}" class="has-text-light player-link"><strong>{{ j.nom }}</strong></a>
                                            </td>
                                            <td class="has-text-right has-text-weight-bold">{{ '%0.2f'| format(j.moyenne_points|float) }}</td>
                                            <td class="has-text-right">
                                                {% if j.score_gm is not none %}
                                                    {% if j.score_gm >= 115 %}
                                                        <span class="has-text-warning has-text-weight-bold">â˜… {{ '%0.2f'| format(j.score_gm|float) }}</span>
                                                    {% elif j.score_gm >= 105 %}
                                                        <span class="has-text-success has-text-weight-bold">{{ '%0.2f'| format(j.score_gm|float) }}</span>
                                                    {% elif j.score_gm >= 95 %}
                                                        <span class="has-text-white">{{ '%0.2f'| format(j.score_gm|float) }}</span>
                                                    {% else %}
                                                        <span class="has-text-danger">{{ '%0.2f'| format(j.score_gm|float) }}</span>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="has-text-grey-light">-</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="moai-container fade-in" style="animation-delay: 0.3s">
                    
                    {% set list_gold = saison.awards.get('super_gold_moai') or saison.awards.get('gold_moai') %}
                    {% set list_silver = saison.awards.get('super_silver_moai') or saison.awards.get('silver_moai') %}
                    {% set list_bronze = saison.awards.get('super_bronze_moai') or saison.awards.get('bronze_moai') %}

                    {% set p1 = list_gold[0] if list_gold else none %}
                    {% set p2 = list_silver[0] if list_silver else none %}
                    {% set p3 = list_bronze[0] if list_bronze else none %}

                    {% if p2 %}
                    <div class="moai-card">
                        <div class="rank-badge" style="background: #C0C0C0; color: #000;">2Ã¨me</div>
                        <img src="/static/img/{{ p2.emoji }}" class="moai-img {{ 'super-moai-silver' if 'super' in p2.emoji else '' }}">
                        <h3 class="title is-4">
                            <a href="/stats/joueur/{{ p2.nom }}" class="has-text-white player-link">{{ p2.nom }}</a>
                        </h3>
                        <p class="subtitle is-6 has-text-grey-light">{{ '%0.2f'| format(p2.val|float) }}</p>
                    </div>
                    {% endif %}

                    {% if p1 %}
                    <div class="moai-card moai-gold">
                        <div class="rank-badge" style="background: #FFD700; color: #000; top: -20px; font-size: 1.2rem;">1er</div>
                        <img src="/static/img/{{ p1.emoji }}" class="moai-img {{ 'super-moai-gold' if 'super' in p1.emoji else '' }}">
                        <h3 class="title is-3 glow-text">
                            <a href="/stats/joueur/{{ p1.nom }}" class="has-text-white player-link">{{ p1.nom }}</a>
                        </h3>
                        <p class="subtitle is-5 has-text-warning">{{ '%0.2f'| format(p1.val|float) }}</p>
                    </div>
                    {% endif %}

                    {% if p3 %}
                    <div class="moai-card">
                        <div class="rank-badge" style="background: #CD7F32; color: #000;">3Ã¨me</div>
                        <img src="/static/img/{{ p3.emoji }}" class="moai-img {{ 'super-moai-bronze' if 'super' in p3.emoji else '' }}">
                        <h3 class="title is-4">
                            <a href="/stats/joueur/{{ p3.nom }}" class="has-text-white player-link">{{ p3.nom }}</a>
                        </h3>
                        <p class="subtitle is-6 has-text-grey-light">{{ '%0.2f'| format(p3.val|float) }}</p>
                    </div>
                    {% endif %}
                </div>

                <div class="box glass-card mt-6 fade-in" style="animation-delay: 0.4s">
                    <h2 class="title is-4 has-text-centered has-text-white mb-5">
                        <i class="fas fa-medal mr-2"></i> Awards SpÃ©ciaux
                    </h2>
                    
                    <div class="columns is-multiline is-centered">
                        
                        {% if 'ez' in saison.awards %}
                        <div class="column is-4">
                            <div class="card has-background-transparent border-light h-100">
                                <div class="card-content has-text-centered">
                                    <div class="award-icon">ðŸ¥‡</div>
                                    <p class="heading has-text-light">EZ</p>
                                    <p class="is-size-7 mb-2">(Le plus de 1Ã¨res places)</p>
                                    {% for winner in saison.awards.ez %}
                                        <p class="title is-4">
                                            <a href="/stats/joueur/{{ winner.nom }}" class="has-text-white player-link">{{ winner.nom }}</a>
                                        </p>
                                        <p class="award-value has-text-warning">{{ winner.val }} Victoires</p>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% if 'pas_loin' in saison.awards %}
                        <div class="column is-4">
                            <div class="card has-background-transparent border-light h-100">
                                <div class="card-content has-text-centered">
                                    <div class="award-icon">ðŸ¥ˆ</div>
                                    <p class="heading has-text-light">C'Ã©tait pas loin</p>
                                    <p class="is-size-7 mb-2">(Le plus de 2Ã¨mes places)</p>
                                    {% for winner in saison.awards.pas_loin %}
                                        <p class="title is-4">
                                            <a href="/stats/joueur/{{ winner.nom }}" class="has-text-white player-link">{{ winner.nom }}</a>
                                        </p>
                                        <p class="award-value has-text-grey-light">{{ winner.val }}x 2Ã¨me</p>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% if 'stakhanov' in saison.awards %}
                        <div class="column is-4">
                            <div class="card has-background-transparent border-light h-100">
                                <div class="card-content has-text-centered">
                                    <div class="award-icon">
                                        <img src="/static/img/TposingFunky.png" class="award-img">
                                    </div>
                                    <p class="heading has-text-light">Stakhanoviste</p>
                                    <p class="is-size-7 mb-2">(Le plus de points amassÃ©)</p>
                                    {% for winner in saison.awards.stakhanov %}
                                        <p class="title is-4">
                                            <a href="/stats/joueur/{{ winner.nom }}" class="has-text-white player-link">{{ winner.nom }}</a>
                                        </p>
                                        <p class="award-value has-text-info">{{ winner.val }} pts</p>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% if 'chillguy' in saison.awards %}
                        <div class="column is-4">
                            <div class="card has-background-transparent border-light h-100">
                                <div class="card-content has-text-centered">
                                    <div class="award-icon">
                                        <img src="/static/img/chillguy.png" class="award-img">
                                    </div>
                                    <p class="heading has-text-light">Chill Guy</p>
                                    <p class="is-size-7 mb-2">(Le score TS le plus stable)</p>
                                    {% for winner in saison.awards.chillguy %}
                                        <p class="title is-4">
                                            <a href="/stats/joueur/{{ winner.nom }}" class="has-text-white player-link">{{ winner.nom }}</a>
                                        </p>
                                        <p class="award-value has-text-grey-light">{{ '%0.2f'| format(winner.val|float) }}</p>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% if 'stonks' in saison.awards %}
                        <div class="column is-4">
                            <div class="card has-background-transparent border-light h-100">
                                <div class="card-content has-text-centered">
                                    <div class="award-icon">
                                        <img src="/static/img/stonks.png" class="award-img">
                                    </div>
                                    <p class="heading has-text-light">Stonks</p>
                                    <p class="is-size-7 mb-2">(Plus forte progression de points TS)</p>
                                    {% for winner in saison.awards.stonks %}
                                        <p class="title is-4">
                                            <a href="/stats/joueur/{{ winner.nom }}" class="has-text-white player-link">{{ winner.nom }}</a>
                                        </p>
                                        <p class="award-value has-text-success">+{{ '%0.2f'| format(winner.val|float) }}</p>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% if 'not_stonks' in saison.awards %}
                        <div class="column is-4">
                            <div class="card has-background-transparent border-light h-100">
                                <div class="card-content has-text-centered">
                                    <div class="award-icon">
                                        <img src="/static/img/not_stonks.png" class="award-img">
                                    </div>
                                    <p class="heading has-text-light">Not Stonks</p>
                                    <p class="is-size-7 mb-2">(Plus grosse perte de points TS)</p>
                                    {% for winner in saison.awards.not_stonks %}
                                        <p class="title is-4">
                                            <a href="/stats/joueur/{{ winner.nom }}" class="has-text-white player-link">{{ winner.nom }}</a>
                                        </p>
                                        <p class="award-value has-text-danger">{{ '%0.2f'| format(winner.val|float) }}</p>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                    </div>
                </div>

            {% endif %}
        </div>
    </section>

    {% include 'footer.html' %}

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const fadeElems = document.querySelectorAll('.fade-in');
            fadeElems.forEach(elem => {
                elem.classList.add('visible');
            });
        });
    </script>
</body>
</html>
